# 5장. 안정 해시 설계

수평적 규모 확장성을 달성하기 위해 요청 또는 데이터를 서버에 균등하게 나누는 것이 중요한데, 특정 서버에 장애가 발생하면 그 특정 서버에 보내던 요청을 나머지 서버에 재분배해야 하는 문제가 발생할 수 있다. 이 문제를 해결하기 위해 **안정 해시**를 사용한다.

## 안정 해시란?

안정 해시는 서버(노드)가 추가되거나 제거될 때 전체 데이터베이스의 재배치가 최소화되도록 설계된 해싱 기법이다. 기본 해시 함수와 달리, 데이터의 해시값을 특정 노드에 고정적으로 매핑하는 대신 해시 공간을 원형(링)으로 배치하여 노드 간의 분배를 동적으로 관리한다.

## 안정 해시 기본 개념

- **해시 링**: 해시 값을 원형 상태로 관리
- **서버 노드**: 각 서버를 해시 값을 통해 링에 배치
- **데이터 매핑**: 데이터를 해시로 링 상의 위치를 찾고, 그 위치에서 가장 가까운 시계 방향의 서버에 매핑
- **가상 노드**: 균등한 분배를 위해 물리적 서버에 여러 개의 가상 노드를 추가하는 방법  
  - 가상 노드를 사용하면 데이터가 특정 서버에 몰리지 않도록 균등하게 분배할 수 있다.
  - 키의 위치로부터 시계 방향으로 링을 탐색하여 만나는 최초의 가상 노드가 해당 키가 저장될 서버가 된다.
  - 가상 노드의 개수를 늘리면 키의 분포는 균등해지지만, 가상 노드 데이터를 저장할 공간이 더 많이 필요하다. *(trade off)*

## 데이터 재배치

서버 추가/제거 시 일부 데이터는 재배치되어야 한다.

최소한의 데이터만 이동하기 위한 재배치 키 결정 방법:

- 해시 링에서 새로 추가된 서버 또는 제거된 서버의 인접 범위 내 데이터만 이동한다.
- 가상 노드를 활용해 서버 간 데이터 분포를 더욱 균등하게 하고, 데이터 이동을 최소화한다.

## 샤딩과 안정 해시의 관계

샤딩된 데이터베이스에서 안정 해시 같은 기법은 데이터를 어떤 샤드에 저장하거나 검색할지 결정하는 데 주로 사용된다.

안정 해시를 사용하면 데이터의 **키(key)** 를 기준으로 적절한 샤드를 빠르게 찾을 수 있다.

- **데이터의 key**: PK 또는 shard key
- **shard key**: 데이터를 샤드에 분배할 때 사용하는 기준이 되는 특정 속성(컬럼)  
  - 주로 PK나 유니크 키가 많이 사용되지만, 어떤 속성도 샤드 키로 지정할 수 있다.
  - 예: 사용자 ID, 주문 번호, 지역 코드, 이메일 주소 등
  - 샤드 키는 해시 기반 또는 범위 기반으로 데이터를 각 샤드에 분배하는 데 사용된다.
    - ex) `userId`를 샤드 키로 선택하고 `Hash(userId) % N` 방식으로 데이터를 할당할 수 있다.

## 샤드 키를 기준으로 데이터를 분배하는 방식

### 1. 해시 기반 샤딩

- 샤드 키의 값을 해시 함수로 변환하여 그 해시 값에 따라 샤드를 결정하는 방식  
  - 예: `Hash(userId) % N`
- **장점**: 데이터가 각 샤드에 골고루 분산되어 특정 샤드에 데이터가 몰리지 않는다.
- **단점**: 샤드 수가 변경되면 전체 데이터가 재배치될 수 있으므로, 이 문제를 해결하기 위해 안정 해시가 자주 사용된다.

### 2. 범위 기반 샤딩

- 샤드 키 값을 범위로 나누어 각 범위에 해당하는 데이터를 특정 샤드에 저장하는 방식이다.

```java
UserID 1 ~ 1000  → 샤드 A  
UserID 1001 ~ 2000  → 샤드 B  
UserID 2001 ~ 3000  → 샤드 C  
```

- **장점**: 특정 범위에 따라 데이터를 쉽게 관리할 수 있다.
- **단점**: 데이터가 비균등하게 분포할 수 있으며, 특정 샤드에 데이터가 몰릴 수 있다.

## 좋은 샤드 키의 조건

1. **고르게 분포되는 값**: 샤드 키의 값이 전체 데이터 공간에 균등하게 분산되어야 한다.  
   - ex) 사용자 ID, 해시된 이메일, 랜덤 생성된 키 등
2. **부하 집중 방지**: 특정 샤드에만 데이터가 몰리지 않도록 샤드 키를 설정해야 한다.  
   - ex) 시간 순으로 증가하는 값(주문 번호, 타임스탬프)은 주의해야 한다.
3. **데이터 액세스 패턴**: 샤드 키가 자주 검색되거나 쿼리되는 필드여야 한다.  
   - ex) 대부분의 쿼리가 `userID`를 기준으로 이루어진다면 `userID`를 샤드 키로 선택하는 것이 좋다.