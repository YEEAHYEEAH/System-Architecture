### 해시 키 재배치 문제
- N개의 캐시 서버가 있을때, 부하를 균등하게 나누는 보편적인 방법
    
    → serverIndex = hash(key)%N(서버의 개수)
    
    - 서버 풀의 크기가 고정되어 있을때, 데이터 분포가 균등할 때는 잘 동작
    - 장애가 발생하면, 대부분의 키가 재분배 됨
    - 대규모 캐시미스가 발생함

### 안정해시

- 안정해시는 해시 테이블 크기가 조정될 때 평균적으로 오직 k/n개의 키만 재배치하는 해시기술(k = 키의 개수, n = 슬롯의 개수)

### 안정 해시의 동작 원리

- 해시함수 f로는 SHA-1을 사용한다고 하고, 그 함수의 출력 값 범위는 x0, x1, x2, …, xn과 같다고 하면 SHA-1의 해시 공간 범위는 0부터 2^160-1까지라고 알려져있음
- x0 = 0, xn = 2^160-1
- 해시공간의 양쪽을 구부려 접으면 해시링이 만들어짐
- 해시 함수 f를 사용하면 서버 IP나 이름을 이 링 위으 어떤 위치에 대응시킬 수 있음
- 해시 키 또한 해시 링 위의 어느 지점에 배치할 수 있음
- 어떤 키가 저장되는 서버는 해당 키의 위치로부터 시계 방향으로 링을 탐색해나가면서 만나는 첫 번째 서버임

![image.png](attachment:4ff0009f-15d4-49a5-9123-227a0f810c62:image.png)

### 안정 해시의 서버 추가

- 서버를 추가하더라도 키 가운데 일부만 재배치하면됨

![image.png](attachment:57d23138-3444-4259-b84a-bd4ee7faa510:image.png)

### 안정 해시의 서버 제거

- 하나의 서버가 제거되면 키 가운데 일부만 재배치됨

![image.png](attachment:c7e48d9d-3fcf-4d64-a46b-4409f550f774:image.png)

### 기본 구현법의 두 가지 문제

- 안정 해시 알고리즘은 MIT에서 처음 제안됨
    - 서버와 키를 균등 분포 해시 함수를 사용해 해시 링에 재배치
    - 키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초의 서버가 키가 저장될 서버
1. 서버가 추가되거나 삭제되는 상황을 감안하면 파티션의 크기를 균등하게 유지하는 것이 불가능
    - 파티션 : 인접한 서버 사이의 해시 공간
    
    → 어떤 서버는 굉장히 작은 해시 공간을 할당받고, 어떤 서버는 굉장히 큰 해시 공간을 할당 받는 상황이 가능할 수 있음
    
2.  키의 균등 분포를 달성하기 어려움

### 가상 노드

- 가상 노드는 실제 노드 또는 서버를 가르키는 노드
- 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있음
- 키의 위치로부터 시계방향으로 링을 탐색하다 만나는 최초의 가상 노드가 해당 키가 저장될 서버
- 가상 노드의 개수를 늘리면 키의 분포는 점점 더 균등해짐
    
    → 표준 편차가 작아져서 데이터가 고르게 분포되기때문
    
    가상노드의 개수 ↑ 표준 편차 ↓ 저장 공간 ↑
